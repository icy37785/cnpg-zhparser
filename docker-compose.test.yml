# docker-compose.test.yml
services:
  postgres:
    build:
      context: .
      # æˆ‘ä»¬ä»ç„¶åªæµ‹è¯• builder é˜¶æ®µï¼Œå› ä¸ºå®ƒæœ‰å¯åŠ¨è„šæœ¬
      target: builder
      args:
        PG_MAJOR: 17
    environment:
      POSTGRES_PASSWORD: "testpass"
      POSTGRES_USER: "testuser"
      POSTGRES_DB: "testdb"
    # è¿™æ˜¯å…³é”®çš„ä¿®å¤ï¼
    # æˆ‘ä»¬è¦†ç›–äº†é»˜è®¤çš„å¯åŠ¨å‘½ä»¤ï¼ŒåŠ å…¥äº†æˆ‘ä»¬éœ€è¦çš„é…ç½®å‚æ•°
    command:
      - "postgres"
      - "-c"
      - "shared_preload_libraries=zhparser"
      - "-c"
      - "zhparser.dict_path=/usr/local/etc"
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser -d testdb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - test-net

  test:
    image: postgres:17-alpine
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGHOST: postgres
      PGDATABASE: testdb
      PGUSER: testuser
      PGPASSWORD: "testpass"
    # æµ‹è¯•è„šæœ¬ä¹Ÿå˜å¾—æ›´ç®€å•äº†ï¼Œå› ä¸ºé…ç½®åœ¨å¯åŠ¨æ—¶å°±å·²ç»ç”Ÿæ•ˆ
    command: |
      sh -c "
        echo 'âœ… Connection successful, server started with zhparser preloaded.'
        sleep 2

        echo '=== Testing Extension Creation ==='
        psql -c 'CREATE EXTENSION IF NOT EXISTS zhparser;'

        echo 'âœ… Extension created!'
        
        echo '=== Testing Text Search Configuration ==='
        psql -c 'CREATE TEXT SEARCH CONFIGURATION chinese_zh (PARSER = zhparser);'

        echo 'âœ… Text search configuration created!'
        
        echo '=== Testing Chinese Word Segmentation (with dictionary) ==='
        # è¿™æ¬¡åº”è¯¥èƒ½çœ‹åˆ°æ­£ç¡®çš„åˆ†è¯ç»“æœäº†ï¼
        psql -c \"SELECT to_tsvector('chinese_zh', 'PostgreSQLä¸­æ–‡å…¨æ–‡æœç´¢æµ‹è¯•');\"
        
        echo 'ğŸ‰ All tests passed successfully!'
      "
    networks:
      - test-net

networks:
  test-net:
    driver: bridge